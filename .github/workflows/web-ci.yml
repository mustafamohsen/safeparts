name: web ci

on:
  push:
    paths:
      - 'web/**'
      - '.github/workflows/web-ci.yml'
  pull_request:
    paths:
      - 'web/**'
      - '.github/workflows/web-ci.yml'

jobs:
  web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 'latest'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-targets: false

      - name: Install WASM build deps
        run: |
          cargo install wasm-pack --locked --version 0.13.1
          cargo install wasm-bindgen-cli --locked --version 0.2.108

      - name: Install web deps
        run: bun install
        working-directory: web

      - name: Build WASM
        run: wasm-pack build ../crates/safeparts_wasm --mode no-install --target web --out-dir ../../web/src/wasm_pkg
        working-directory: web

      - name: Build web app
        run: bun run build
        working-directory: web

      - name: Install docs deps
        run: bun install
        working-directory: web/help

      - name: Build docs
        run: bun run build
        working-directory: web/help

      - name: Install Playwright browsers
        run: bun run test:a11y:install
        working-directory: web

      - name: Run a11y tests
        run: |
          bun run dev &
          sleep 5
          bun run test:a11y
        working-directory: web
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:5173

  netlify_build:
    name: netlify build hook
    runs-on: ubuntu-latest
    needs: web
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Trigger Netlify build
        env:
          NETLIFY_BUILD_HOOK_URL: ${{ secrets.NETLIFY_BUILD_HOOK_URL }}
        run: |
          if [ -z "$NETLIFY_BUILD_HOOK_URL" ]; then
            echo "NETLIFY_BUILD_HOOK_URL not set; skipping Netlify build trigger."
            exit 0
          fi

          curl --fail --silent --show-error -X POST "$NETLIFY_BUILD_HOOK_URL"
